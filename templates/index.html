<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Tracker</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     crossorigin=""/>
    
    <!-- Font Awesome (for icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/custom.css">
</head>
<body>
    <div class="container py-4">
        <header class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="fas fa-plane me-2"></i>
                    Flight Tracker
                </h1>
                <div class="d-flex align-items-center">
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="autoRefreshToggle">
                        <label class="form-check-label" for="autoRefreshToggle">
                            Auto-refresh
                        </label>
                    </div>
                    <button class="btn btn-sm btn-outline-info" id="refreshButton">
                        <i class="fas fa-sync-alt"></i> Refresh All
                    </button>
                </div>
            </div>
        </header>
        
        <div class="row g-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Flight Tracker Control Panel</h5>
                        <div class="d-flex align-items-center">
                            <div class="form-check form-switch me-3">
                                <input class="form-check-input" type="checkbox" id="mapToggle" checked>
                                <label class="form-check-label" for="mapToggle">Show Map</label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="flight-form">
                            <form id="flightForm">
                                <div class="mb-3">
                                    <label for="flightNumber" class="form-label">Add Flight</label>
                                    <div class="input-group">
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="flightNumber"
                                            placeholder="e.g., BA123"
                                        >
                                        <button class="btn btn-primary" type="submit" id="addFlightBtn">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Enter the airline code and flight number (e.g., BA123, DL4567)
                                    </small>
                                    <div class="mt-2">
                                        <span class="badge bg-info" id="flightCounter">0/3 Flights</span>
                                        <small class="ms-2 text-muted">Maximum 3 flights can be tracked at once</small>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="flight-list">
                            <div class="empty-state">
                                <p>No flights added yet</p>
                                <small>Add a flight using the form above</small>
                            </div>
                            <ul class="list-group" id="flightsList" style="display: none;">
                                <!-- Flight items will be added here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-12">
                <div id="allFlightsContainer">
                    <div class="card empty-state" id="emptyState">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-plane fa-3x mb-3"></i>
                            <h3>No Flights Added</h3>
                            <p>Add flights using the form above to view their details here.</p>
                        </div>
                    </div>
                    <!-- All flight detail cards will be inserted here -->
                </div>
            </div>
        </div>
        
        <footer class="mt-5 text-center text-muted">
            <small>Â© <span id="currentYear"></span> Flight Tracker | Data refreshed manually</small>
        </footer>
    </div>
    
    <!-- Bootstrap JS bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <!-- Application JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Initialize map
            let map = null;
            function initMap() {
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer) {
                    map = L.map(mapContainer).setView([20, 0], 2);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        maxZoom: 19,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                }
            }
            
            // Form submission
            const flightForm = document.getElementById('flightForm');
            flightForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const flightNumber = document.getElementById('flightNumber').value.trim().toUpperCase();
                if (flightNumber) {
                    addFlight(flightNumber);
                }
            });
            
            // Add flight function
            function addFlight(flightNumber) {
                console.log('Adding flight:', flightNumber);
                fetch('/api/flights/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ flight_number: flightNumber }),
                })
                .then(response => {
                    console.log('Add flight response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Add flight response data:', data);
                    if (data.success) {
                        document.getElementById('flightNumber').value = '';
                        fetchFlights();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to add flight'));
                    }
                })
                .catch(error => {
                    console.error('Error adding flight:', error);
                    alert('Error connecting to server');
                });
            }
            
            // Map toggle functionality
            document.getElementById('mapToggle').addEventListener('change', function() {
                const mapContainers = document.querySelectorAll('.map-container');
                mapContainers.forEach(container => {
                    container.style.display = this.checked ? 'block' : 'none';
                });
            });
            
            // Fetch flights function
            function fetchFlights() {
                console.log('Fetching flights...');
                fetch('/api/flights')
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Flights data:', data);
                    if (data.success) {
                        const flightsList = document.getElementById('flightsList');
                        const emptyState = document.querySelector('.empty-state');
                        const flightCounter = document.getElementById('flightCounter');
                        const addFlightBtn = document.getElementById('addFlightBtn');
                        
                        // Update flight counter
                        flightCounter.textContent = `${data.flights.length}/3 Flights`;
                        
                        // Disable add button if we already have 3 flights
                        if (data.flights.length >= 3) {
                            addFlightBtn.disabled = true;
                            addFlightBtn.title = "Maximum limit reached (3 flights)";
                        } else {
                            addFlightBtn.disabled = false;
                            addFlightBtn.title = "";
                        }
                        
                        if (data.flights.length > 0) {
                            flightsList.style.display = 'block';
                            emptyState.style.display = 'none';
                            
                            // Update all flight details
                            updateAllFlightDetails(data.flights);
                            
                            flightsList.innerHTML = '';
                            data.flights.forEach(flight => {
                                const li = document.createElement('li');
                                li.className = 'list-group-item flight-card d-flex justify-content-between align-items-center';
                                li.dataset.flightNumber = flight.flight_number;
                                
                                // Get status class
                                function getStatusClass(status) {
                                    if (!status) return 'text-secondary';
                                    const statusLower = status.toLowerCase();
                                    if (statusLower.includes('scheduled')) return 'text-primary';
                                    if (statusLower.includes('active') || statusLower.includes('en-route')) return 'text-success';
                                    if (statusLower.includes('landed')) return 'text-info';
                                    if (statusLower.includes('cancelled')) return 'text-danger';
                                    if (statusLower.includes('delayed')) return 'text-warning';
                                    if (statusLower.includes('diverted')) return 'text-warning';
                                    return 'text-secondary';
                                }
                                
                                // Get status icon
                                function getStatusIcon(status) {
                                    if (!status) return 'question-circle';
                                    const statusLower = status.toLowerCase();
                                    if (statusLower.includes('scheduled')) return 'calendar-check';
                                    if (statusLower.includes('active') || statusLower.includes('en-route')) return 'plane';
                                    if (statusLower.includes('landed')) return 'check-circle';
                                    if (statusLower.includes('cancelled')) return 'times-circle';
                                    if (statusLower.includes('delayed')) return 'clock';
                                    if (statusLower.includes('diverted')) return 'exclamation-triangle';
                                    return 'question-circle';
                                }
                                
                                const statusClass = getStatusClass(flight.status);
                                const statusIcon = getStatusIcon(flight.status);
                                
                                li.innerHTML = `
                                    <div>
                                        <strong>${flight.flight_number}</strong>
                                        <div class="small ${statusClass}">
                                            <i class="fas fa-${statusIcon} me-1"></i>
                                            ${flight.status || 'Unknown'}
                                        </div>
                                    </div>
                                    <div>
                                        <a href="https://flightaware.com/live/flight/${flight.flight_number}" 
                                           class="btn btn-sm btn-outline-info me-1" 
                                           target="_blank" 
                                           title="View on FlightAware">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger remove-flight">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                `;
                                li.addEventListener('click', function(e) {
                                    if (!e.target.closest('.remove-flight')) {
                                        selectFlight(flight.flight_number);
                                    }
                                });
                                
                                li.querySelector('.remove-flight').addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    removeFlight(flight.flight_number);
                                });
                                
                                flightsList.appendChild(li);
                            });
                            
                            // Select first flight if none selected
                            if (!document.querySelector('.flight-card.active') && data.flights.length > 0) {
                                selectFlight(data.flights[0].flight_number);
                            }
                        } else {
                            flightsList.style.display = 'none';
                            emptyState.style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching flights:', error);
                });
            }
            
            // Select flight function
            function selectFlight(flightNumber) {
                console.log('Selecting flight:', flightNumber);
                
                // Highlight selected flight
                document.querySelectorAll('.flight-card').forEach(card => {
                    card.classList.remove('active');
                });
                const selectedCard = document.querySelector(`.flight-card[data-flight-number="${flightNumber}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('active');
                }
                
                // Check if we already have a flight detail card for this flight
                const existingCard = document.getElementById(`flight-card-${flightNumber}`);
                if (!existingCard) {
                    // Create a loading card while we fetch details
                    addBasicFlightCard(flightNumber);
                }
                
                // Fetch flight details
                fetch(`/api/flights/details/${flightNumber}`)
                .then(response => {
                    console.log(`Select flight response status for ${flightNumber}:`, response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Select flight data for ${flightNumber}:`, data);
                    if (data.success) {
                        displayFlightDetails(data.flight);
                    } else {
                        console.error('Error:', data.error || 'Could not fetch flight details');
                    }
                })
                .catch(error => {
                    console.error('Error fetching flight details:', error);
                });
                
                // Helper function to add a basic card when details can't be fetched
                function addBasicFlightCard(flightNumber) {
                    const allFlightsContainer = document.getElementById('allFlightsContainer');
                    const flightCard = document.createElement('div');
                    flightCard.className = 'card mb-4 flight-detail-card';
                    flightCard.id = `flight-card-${flightNumber}`;
                    
                    flightCard.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">${flightNumber}</h5>
                                <div class="small text-secondary">
                                    <i class="fas fa-circle me-1"></i>
                                    Loading status...
                                </div>
                            </div>
                            <div class="d-flex">
                                <a href="https://flightaware.com/live/flight/${flightNumber}" 
                                   class="btn btn-sm btn-outline-info me-2" 
                                   target="_blank" 
                                   title="View on FlightAware">
                                    <i class="fas fa-external-link-alt me-1"></i>
                                    FlightAware
                                </a>
                                <button class="btn btn-sm btn-outline-secondary" onclick="refreshSingleFlight('${flightNumber}')">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info text-center">
                                <i class="fas fa-sync fa-spin me-2"></i>
                                Loading flight details...
                            </div>
                        </div>
                    `;
                    
                    allFlightsContainer.appendChild(flightCard);
                }
            }
            
            // Remove flight function
            function removeFlight(flightNumber) {
                if (confirm(`Are you sure you want to remove flight ${flightNumber}?`)) {
                    console.log('Removing flight:', flightNumber);
                    fetch(`/api/flights/remove/${flightNumber}`, {
                        method: 'DELETE',
                    })
                    .then(response => {
                        console.log('Remove flight response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Remove flight response data:', data);
                        if (data.success) {
                            // Remove the flight's detail card if it exists
                            const flightCard = document.getElementById(`flight-card-${flightNumber}`);
                            if (flightCard) {
                                flightCard.remove();
                            }
                            
                            // Refresh the flights list
                            fetchFlights();
                        } else {
                            alert('Error: ' + (data.error || 'Failed to remove flight'));
                        }
                    })
                    .catch(error => {
                        console.error('Error removing flight:', error);
                    });
                }
            }
            
            // Update all flight details function
            function updateAllFlightDetails(flights) {
                const allFlightsContainer = document.getElementById('allFlightsContainer');
                const emptyState = document.getElementById('emptyState');
                
                if (flights.length === 0) {
                    emptyState.style.display = 'block';
                    allFlightsContainer.innerHTML = '';
                    return;
                }
                
                emptyState.style.display = 'none';
                allFlightsContainer.innerHTML = '';
                
                let completedFlights = 0;
                flights.forEach(flightInfo => {
                    console.log('Fetching details for flight:', flightInfo.flight_number);
                    fetch(`/api/flights/details/${flightInfo.flight_number}`)
                    .then(response => {
                        console.log(`Flight details response status for ${flightInfo.flight_number}:`, response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Flight details data for ${flightInfo.flight_number}:`, data);
                        if (data.success) {
                            addFlightDetailCard(data.flight);
                        } else {
                            console.warn(`Failed to get details for ${flightInfo.flight_number}:`, data.error);
                            // Create a basic card for this flight
                            addBasicFlightCard(flightInfo.flight_number);
                        }
                    })
                    .catch(error => {
                        console.error(`Error fetching details for ${flightInfo.flight_number}:`, error);
                        // Create a basic card for this flight
                        addBasicFlightCard(flightInfo.flight_number);
                    })
                    .finally(() => {
                        completedFlights++;
                        console.log(`Completed ${completedFlights}/${flights.length} flight detail requests`);
                    });
                });
                
                // Helper function to add a basic card when details can't be fetched
                function addBasicFlightCard(flightNumber) {
                    const allFlightsContainer = document.getElementById('allFlightsContainer');
                    const flightCard = document.createElement('div');
                    flightCard.className = 'card mb-4 flight-detail-card';
                    flightCard.id = `flight-card-${flightNumber}`;
                    
                    flightCard.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">${flightNumber}</h5>
                                <div class="small text-secondary">
                                    <i class="fas fa-circle me-1"></i>
                                    Loading status...
                                </div>
                            </div>
                            <div class="d-flex">
                                <a href="https://flightaware.com/live/flight/${flightNumber}" 
                                   class="btn btn-sm btn-outline-info me-2" 
                                   target="_blank" 
                                   title="View on FlightAware">
                                    <i class="fas fa-external-link-alt me-1"></i>
                                    FlightAware
                                </a>
                                <button class="btn btn-sm btn-outline-secondary" onclick="refreshSingleFlight('${flightNumber}')">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info text-center">
                                <i class="fas fa-sync fa-spin me-2"></i>
                                Loading flight details...
                            </div>
                        </div>
                    `;
                    
                    allFlightsContainer.appendChild(flightCard);
                }
            }
            
            // Create a single flight detail card
            function addFlightDetailCard(flight) {
                const allFlightsContainer = document.getElementById('allFlightsContainer');
                const flightCard = document.createElement('div');
                flightCard.className = 'card mb-4 flight-detail-card';
                flightCard.id = `flight-card-${flight.flight_number}`;
                
                // Create map container ID specific to this flight
                const mapContainerId = `map-container-${flight.flight_number}`;
                
                // Add card content
                flightCard.innerHTML = createFlightDetailCardContent(flight, mapContainerId);
                
                // Add to container
                allFlightsContainer.appendChild(flightCard);
                
                // Initialize map for this flight if coordinates are available
                initFlightMap(flight, mapContainerId);
            }
            
            // Display flight details function (now just refreshes the card for the given flight)
            function displayFlightDetails(flight) {
                // This function is kept for compatibility but now just refreshes the card
                
                // Check if this flight already has a card
                const existingCard = document.getElementById(`flight-card-${flight.flight_number}`);
                
                // If we found the card, update it
                if (existingCard) {
                    const mapContainerId = `map-container-${flight.flight_number}`;
                    existingCard.innerHTML = createFlightDetailCardContent(flight, mapContainerId);
                    initFlightMap(flight, mapContainerId);
                } else {
                    // If no card exists yet, add it
                    addFlightDetailCard(flight);
                }
            }
            
            // Create flight detail card content
            function createFlightDetailCardContent(flight, mapContainerId) {
                // Format date function
                function formatDateTime(dateTimeStr) {
                    if (!dateTimeStr) return 'N/A';
                    const date = new Date(dateTimeStr);
                    const options = { 
                        weekday: 'short',
                        day: 'numeric', 
                        month: 'short', 
                        year: 'numeric',
                        hour: '2-digit', 
                        minute: '2-digit',
                        timeZoneName: 'short'
                    };
                    return date.toLocaleString('en-US', options);
                }
                
                // Calculate and format delay
                function calculateDelay(scheduled, actual) {
                    if (!scheduled || !actual) return null;
                    const scheduledDate = new Date(scheduled);
                    const actualDate = new Date(actual);
                    return Math.round((actualDate - scheduledDate) / (1000 * 60));
                }
                
                function formatDelay(delayMinutes) {
                    if (delayMinutes === null) return '';
                    if (delayMinutes <= 0) {
                        return '<span class="text-success">On time</span>';
                    }
                    const hours = Math.floor(delayMinutes / 60);
                    const minutes = delayMinutes % 60;
                    let delayText = '';
                    if (hours > 0) {
                        delayText += `${hours}h `;
                    }
                    if (minutes > 0 || hours === 0) {
                        delayText += `${minutes}m`;
                    }
                    return `<span class="text-warning">Delayed by ${delayText}</span>`;
                }
                
                // Get status class
                function getStatusClass(status) {
                    if (!status) return 'text-secondary';
                    const statusLower = status.toLowerCase();
                    if (statusLower.includes('scheduled')) return 'text-primary';
                    if (statusLower.includes('active') || statusLower.includes('en-route')) return 'text-success';
                    if (statusLower.includes('landed')) return 'text-info';
                    if (statusLower.includes('cancelled')) return 'text-danger';
                    if (statusLower.includes('delayed')) return 'text-warning';
                    if (statusLower.includes('diverted')) return 'text-warning';
                    return 'text-secondary';
                }
                
                const departureDelay = calculateDelay(flight.scheduled_departure, flight.actual_departure);
                const arrivalDelay = calculateDelay(flight.scheduled_arrival, flight.actual_arrival);
                const statusClass = getStatusClass(flight.status);
                
                // Check if we have map coordinates
                const hasMapData = flight.departure_lat && flight.departure_lon && 
                                  flight.arrival_lat && flight.arrival_lon;
                
                return `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                ${flight.airline ? `${flight.airline} ` : ''}
                                ${flight.flight_number}
                            </h5>
                            <div class="small ${statusClass}">
                                <i class="fas fa-circle me-1"></i>
                                ${flight.status || 'Unknown Status'}
                            </div>
                        </div>
                        <div class="d-flex">
                            <a href="https://flightaware.com/live/flight/${flight.flight_number}" 
                               class="btn btn-sm btn-outline-info me-2" 
                               target="_blank" 
                               title="View on FlightAware">
                                <i class="fas fa-external-link-alt me-1"></i>
                                FlightAware
                            </a>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshSingleFlight('${flight.flight_number}')">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <div class="alert alert-secondary mb-0">
                                    <div>
                                        <strong>From:</strong> ${flight.departure_airport || 'N/A'}
                                    </div>
                                    <div>
                                        <small>${formatDateTime(flight.scheduled_departure)}</small>
                                    </div>
                                    <div class="mt-1">
                                        ${formatDelay(departureDelay)}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="alert alert-secondary mb-0">
                                    <div>
                                        <strong>To:</strong> ${flight.arrival_airport || 'N/A'}
                                    </div>
                                    <div>
                                        <small>${formatDateTime(flight.scheduled_arrival)}</small>
                                    </div>
                                    <div class="mt-1">
                                        ${formatDelay(arrivalDelay)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${hasMapData ? 
                            `<div class="map-container mb-3" id="${mapContainerId}" style="height: 250px;"></div>` : 
                            `<div class="alert alert-secondary text-center mb-3">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                Map unavailable: No coordinate data
                            </div>`
                        }
                        
                        ${(flight.altitude || flight.speed) ? `
                        <div class="row mb-3">
                            ${flight.altitude ? `
                            <div class="col-md-6 mb-2">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-arrow-up me-2"></i>
                                    <div>
                                        <div class="text-muted small">Altitude</div>
                                        <div><strong>${flight.altitude.toLocaleString()} ft</strong></div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${flight.speed ? `
                            <div class="col-md-6 mb-2">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-tachometer-alt me-2"></i>
                                    <div>
                                        <div class="text-muted small">Speed</div>
                                        <div><strong>${flight.speed.toLocaleString()} km/h</strong></div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <div class="text-end">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Last updated: ${formatDateTime(flight.last_updated)}
                            </small>
                        </div>
                    </div>
                `;
            }
            
            // Initialize map for a specific flight
            function initFlightMap(flight, mapContainerId) {
                // Check if we should display the map based on toggle state
                const mapToggle = document.getElementById('mapToggle');
                const mapContainer = document.getElementById(mapContainerId);
                
                if (!mapContainer) return;
                
                // Apply map toggle setting
                if (!mapToggle.checked) {
                    mapContainer.style.display = 'none';
                }
                
                // Check if we have map data
                if (!flight.departure_lat || !flight.departure_lon || 
                    !flight.arrival_lat || !flight.arrival_lon) {
                    return;
                }
                
                // Initialize the map
                const map = L.map(mapContainerId).setView([20, 0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Create custom airport marker icon
                const airportIcon = L.divIcon({
                    html: '<i class="fas fa-map-marker-alt fa-2x text-info"></i>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 20],
                    className: 'airport-marker'
                });
                
                // Create custom plane marker icon
                const planeIcon = L.divIcon({
                    html: '<i class="fas fa-plane text-warning"></i>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10],
                    className: 'plane-marker'
                });
                
                // Add departure marker
                const departureMarker = L.marker([flight.departure_lat, flight.departure_lon], { icon: airportIcon }).addTo(map);
                departureMarker.bindPopup(`<strong>${flight.departure_airport}</strong><br>Departure Airport`);
                
                // Add arrival marker
                const arrivalMarker = L.marker([flight.arrival_lat, flight.arrival_lon], { icon: airportIcon }).addTo(map);
                arrivalMarker.bindPopup(`<strong>${flight.arrival_airport}</strong><br>Arrival Airport`);
                
                // Draw flight path
                const latlngs = [
                    [flight.departure_lat, flight.departure_lon],
                    [flight.arrival_lat, flight.arrival_lon]
                ];
                L.polyline(latlngs, {
                    color: '#1e88e5',
                    weight: 2,
                    opacity: 0.7,
                    className: 'flight-path'
                }).addTo(map);
                
                // Add current position if available
                if (flight.current_lat && flight.current_lon) {
                    const planeMarker = L.marker([flight.current_lat, flight.current_lon], { icon: planeIcon }).addTo(map);
                    planeMarker.bindPopup(`
                        <strong>${flight.flight_number}</strong><br>
                        ${flight.altitude ? `Altitude: ${flight.altitude.toLocaleString()} ft<br>` : ''}
                        ${flight.speed ? `Speed: ${flight.speed.toLocaleString()} km/h` : ''}
                    `);
                }
                
                // Fit bounds to show all markers
                const bounds = L.latLngBounds([
                    [flight.departure_lat, flight.departure_lon],
                    [flight.arrival_lat, flight.arrival_lon]
                ]);
                if (flight.current_lat && flight.current_lon) {
                    bounds.extend([flight.current_lat, flight.current_lon]);
                }
                map.fitBounds(bounds, { padding: [30, 30] });
            }
            
            // Refresh single flight function
            function refreshSingleFlight(flightNumber) {
                console.log('Refreshing flight:', flightNumber);
                
                // Show loading state on the card
                const existingCard = document.getElementById(`flight-card-${flightNumber}`);
                if (existingCard) {
                    existingCard.querySelector('.card-body').innerHTML = `
                        <div class="alert alert-info text-center">
                            <i class="fas fa-sync fa-spin me-2"></i>
                            Refreshing flight data...
                        </div>
                    `;
                }
                
                fetch(`/api/flights/update/${flightNumber}`)
                .then(response => {
                    console.log(`Refresh flight response status for ${flightNumber}:`, response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Refresh flight data for ${flightNumber}:`, data);
                    if (data.success) {
                        // Remove existing card
                        const existingCard = document.getElementById(`flight-card-${flightNumber}`);
                        if (existingCard) {
                            existingCard.remove();
                        }
                        
                        // Add updated card
                        addFlightDetailCard(data.flight);
                    } else {
                        alert('Error: ' + (data.error || 'Failed to update flight data'));
                        // Reset the card to its previous state by refreshing the whole list
                        fetchFlights();
                    }
                })
                .catch(error => {
                    console.error('Error refreshing flight:', error);
                    // Reset the card to its previous state by refreshing the whole list
                    fetchFlights();
                });
            }
            
            // Refresh all flights function
            document.getElementById('refreshButton').addEventListener('click', function() {
                fetch('/api/flights/update-all')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        fetchFlights();
                        const activeFlightCard = document.querySelector('.flight-card.active');
                        if (activeFlightCard) {
                            const flightNumber = activeFlightCard.dataset.flightNumber;
                            selectFlight(flightNumber);
                        }
                    } else {
                        alert('Error: ' + (data.error || 'Failed to update flights'));
                    }
                })
                .catch(error => {
                    console.error('Error refreshing all flights:', error);
                });
            });
            
            // Auto-refresh toggle
            let autoRefreshInterval = null;
            document.getElementById('autoRefreshToggle').addEventListener('change', function() {
                if (this.checked) {
                    autoRefreshInterval = setInterval(function() {
                        document.getElementById('refreshButton').click();
                    }, 60000); // Refresh every minute
                    document.querySelector('footer small').textContent = `Â© ${new Date().getFullYear()} Flight Tracker | Data refreshed automatically`;
                } else {
                    clearInterval(autoRefreshInterval);
                    document.querySelector('footer small').textContent = `Â© ${new Date().getFullYear()} Flight Tracker | Data refreshed manually`;
                }
            });
            
            // Initial fetch of flights
            fetchFlights();
        });
    </script>
</body>
</html>