<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Tracker</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     crossorigin=""/>
    
    <!-- Font Awesome (for icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/custom.css">
</head>
<body>
    <div class="container py-4">
        <header class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="fas fa-plane me-2"></i>
                    Flight Tracker
                </h1>
                <div class="d-flex align-items-center">
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="autoRefreshToggle">
                        <label class="form-check-label" for="autoRefreshToggle">
                            Auto-refresh
                        </label>
                    </div>
                    <button class="btn btn-sm btn-outline-info" id="refreshButton">
                        <i class="fas fa-sync-alt"></i> Refresh All
                    </button>
                </div>
            </div>
        </header>
        
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Tracked Flights</h5>
                    </div>
                    <div class="card-body">
                        <div class="flight-form">
                            <form id="flightForm">
                                <div class="mb-3">
                                    <label for="flightNumber" class="form-label">Add Flight</label>
                                    <div class="input-group">
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="flightNumber"
                                            placeholder="e.g., BA123"
                                        >
                                        <button class="btn btn-primary" type="submit">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Enter the airline code and flight number (e.g., BA123, DL4567)
                                    </small>
                                </div>
                            </form>
                        </div>
                        <hr />
                        <div class="flight-list">
                            <div class="empty-state">
                                <p>No flights added yet</p>
                                <small>Add a flight using the form above</small>
                            </div>
                            <ul class="list-group" id="flightsList" style="display: none;">
                                <!-- Flight items will be added here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body empty-state" id="emptyState">
                        <i class="fas fa-plane"></i>
                        <h3>No Flight Selected</h3>
                        <p>Add a flight or select one from the list to view its details.</p>
                    </div>
                    <div class="card" id="flightDetailsCard" style="display: none;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Flight Details</h5>
                            <button class="btn btn-sm btn-outline-secondary" id="refreshFlightButton">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="map-container mb-4" id="mapContainer"></div>
                            <div class="flight-details" id="flightDetails">
                                <!-- Flight details will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="mt-5 text-center text-muted">
            <small>© <span id="currentYear"></span> Flight Tracker | Data refreshed manually</small>
        </footer>
    </div>
    
    <!-- Bootstrap JS bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <!-- Application JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Initialize map
            let map = null;
            function initMap() {
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer) {
                    map = L.map(mapContainer).setView([20, 0], 2);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        maxZoom: 19,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                }
            }
            
            // Form submission
            const flightForm = document.getElementById('flightForm');
            flightForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const flightNumber = document.getElementById('flightNumber').value.trim().toUpperCase();
                if (flightNumber) {
                    addFlight(flightNumber);
                }
            });
            
            // Add flight function
            function addFlight(flightNumber) {
                fetch('/api/flights/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ flight_number: flightNumber }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('flightNumber').value = '';
                        fetchFlights();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to add flight'));
                    }
                })
                .catch(error => {
                    console.error('Error adding flight:', error);
                    alert('Error connecting to server');
                });
            }
            
            // Fetch flights function
            function fetchFlights() {
                fetch('/api/flights')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const flightsList = document.getElementById('flightsList');
                        const emptyState = document.querySelector('.empty-state');
                        
                        if (data.flights.length > 0) {
                            flightsList.style.display = 'block';
                            emptyState.style.display = 'none';
                            
                            flightsList.innerHTML = '';
                            data.flights.forEach(flight => {
                                const li = document.createElement('li');
                                li.className = 'list-group-item flight-card d-flex justify-content-between align-items-center';
                                li.dataset.flightNumber = flight.flight_number;
                                li.innerHTML = `
                                    <div>
                                        <strong>${flight.flight_number}</strong>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger remove-flight">
                                        <i class="fas fa-times"></i>
                                    </button>
                                `;
                                li.addEventListener('click', function(e) {
                                    if (!e.target.closest('.remove-flight')) {
                                        selectFlight(flight.flight_number);
                                    }
                                });
                                
                                li.querySelector('.remove-flight').addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    removeFlight(flight.flight_number);
                                });
                                
                                flightsList.appendChild(li);
                            });
                            
                            // Select first flight if none selected
                            if (!document.querySelector('.flight-card.active') && data.flights.length > 0) {
                                selectFlight(data.flights[0].flight_number);
                            }
                        } else {
                            flightsList.style.display = 'none';
                            emptyState.style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching flights:', error);
                });
            }
            
            // Select flight function
            function selectFlight(flightNumber) {
                // Highlight selected flight
                document.querySelectorAll('.flight-card').forEach(card => {
                    card.classList.remove('active');
                });
                const selectedCard = document.querySelector(`.flight-card[data-flight-number="${flightNumber}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('active');
                }
                
                // Fetch flight details
                fetch(`/api/flights/details/${flightNumber}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayFlightDetails(data.flight);
                    } else {
                        alert('Error: ' + (data.error || 'Failed to fetch flight details'));
                    }
                })
                .catch(error => {
                    console.error('Error fetching flight details:', error);
                });
            }
            
            // Remove flight function
            function removeFlight(flightNumber) {
                if (confirm(`Are you sure you want to remove flight ${flightNumber}?`)) {
                    fetch(`/api/flights/remove/${flightNumber}`, {
                        method: 'DELETE',
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            fetchFlights();
                            document.getElementById('emptyState').style.display = 'block';
                            document.getElementById('flightDetailsCard').style.display = 'none';
                        } else {
                            alert('Error: ' + (data.error || 'Failed to remove flight'));
                        }
                    })
                    .catch(error => {
                        console.error('Error removing flight:', error);
                    });
                }
            }
            
            // Display flight details function
            function displayFlightDetails(flight) {
                const emptyState = document.getElementById('emptyState');
                const flightDetailsCard = document.getElementById('flightDetailsCard');
                const flightDetailsDiv = document.getElementById('flightDetails');
                
                emptyState.style.display = 'none';
                flightDetailsCard.style.display = 'block';
                
                // Format date function
                function formatDateTime(dateTimeStr) {
                    if (!dateTimeStr) return 'N/A';
                    const date = new Date(dateTimeStr);
                    const options = { 
                        weekday: 'short',
                        day: 'numeric', 
                        month: 'short', 
                        year: 'numeric',
                        hour: '2-digit', 
                        minute: '2-digit',
                        timeZoneName: 'short'
                    };
                    return date.toLocaleString('en-US', options);
                }
                
                // Calculate and format delay
                function calculateDelay(scheduled, actual) {
                    if (!scheduled || !actual) return null;
                    const scheduledDate = new Date(scheduled);
                    const actualDate = new Date(actual);
                    return Math.round((actualDate - scheduledDate) / (1000 * 60));
                }
                
                function formatDelay(delayMinutes) {
                    if (delayMinutes === null) return '';
                    if (delayMinutes <= 0) {
                        return '<span class="text-success">On time</span>';
                    }
                    const hours = Math.floor(delayMinutes / 60);
                    const minutes = delayMinutes % 60;
                    let delayText = '';
                    if (hours > 0) {
                        delayText += `${hours}h `;
                    }
                    if (minutes > 0 || hours === 0) {
                        delayText += `${minutes}m`;
                    }
                    return `<span class="text-warning">Delayed by ${delayText}</span>`;
                }
                
                // Get status class
                function getStatusClass(status) {
                    if (!status) return 'status-unknown';
                    const statusLower = status.toLowerCase();
                    if (statusLower.includes('scheduled')) return 'status-scheduled';
                    if (statusLower.includes('active') || statusLower.includes('en-route')) return 'status-active';
                    if (statusLower.includes('landed')) return 'status-landed';
                    if (statusLower.includes('cancelled')) return 'status-cancelled';
                    if (statusLower.includes('delayed')) return 'status-delayed';
                    if (statusLower.includes('diverted')) return 'status-diverted';
                    return 'status-unknown';
                }
                
                const departureDelay = calculateDelay(flight.scheduled_departure, flight.actual_departure);
                const arrivalDelay = calculateDelay(flight.scheduled_arrival, flight.actual_arrival);
                const statusClass = getStatusClass(flight.status);
                
                // Update flight details
                flightDetailsDiv.innerHTML = `
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="alert alert-secondary d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="alert-heading mb-0">
                                        ${flight.airline ? `${flight.airline} ` : ''}
                                        ${flight.flight_number}
                                    </h4>
                                    <div class="${statusClass}">
                                        <i class="fas fa-circle me-1"></i>
                                        ${flight.status || 'Unknown Status'}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div>
                                        <strong>From:</strong> ${flight.departure_airport || 'N/A'}
                                    </div>
                                    <div>
                                        <strong>To:</strong> ${flight.arrival_airport || 'N/A'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0">Departure</h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-1">
                                        <strong>Airport:</strong> ${flight.departure_airport || 'N/A'}
                                    </p>
                                    <p class="mb-1">
                                        <strong>Scheduled:</strong> ${formatDateTime(flight.scheduled_departure)}
                                    </p>
                                    <p class="mb-1">
                                        <strong>Actual:</strong> ${formatDateTime(flight.actual_departure)}
                                    </p>
                                    <p class="mb-0 delay-indicator">
                                        ${formatDelay(departureDelay)}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0">Arrival</h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-1">
                                        <strong>Airport:</strong> ${flight.arrival_airport || 'N/A'}
                                    </p>
                                    <p class="mb-1">
                                        <strong>Scheduled:</strong> ${formatDateTime(flight.scheduled_arrival)}
                                    </p>
                                    <p class="mb-1">
                                        <strong>Actual:</strong> ${formatDateTime(flight.actual_arrival)}
                                    </p>
                                    <p class="mb-0 delay-indicator">
                                        ${formatDelay(arrivalDelay)}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        ${(flight.altitude || flight.speed) ? `
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Live Data</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        ${flight.altitude ? `
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-arrow-up me-2"></i>
                                                <div>
                                                    <div class="text-muted small">Altitude</div>
                                                    <div><strong>${flight.altitude.toLocaleString()} ft</strong></div>
                                                </div>
                                            </div>
                                        </div>
                                        ` : ''}
                                        
                                        ${flight.speed ? `
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-tachometer-alt me-2"></i>
                                                <div>
                                                    <div class="text-muted small">Speed</div>
                                                    <div><strong>${flight.speed.toLocaleString()} km/h</strong></div>
                                                </div>
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="col-12">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Last updated: ${formatDateTime(flight.last_updated)}
                            </small>
                        </div>
                    </div>
                `;
                
                // Update map
                if (!map) {
                    initMap();
                } else {
                    map.remove();
                    initMap();
                }
                
                if (map && flight.departure_lat && flight.departure_lon && flight.arrival_lat && flight.arrival_lon) {
                    // Create custom airport marker icon
                    const airportIcon = L.divIcon({
                        html: '<i class="fas fa-map-marker-alt fa-2x text-info"></i>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 20],
                        className: 'airport-marker'
                    });
                    
                    // Create custom plane marker icon
                    const planeIcon = L.divIcon({
                        html: '<i class="fas fa-plane text-warning"></i>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10],
                        className: 'plane-marker'
                    });
                    
                    // Add departure marker
                    const departureMarker = L.marker([flight.departure_lat, flight.departure_lon], { icon: airportIcon }).addTo(map);
                    departureMarker.bindPopup(`<strong>${flight.departure_airport}</strong><br>Departure Airport`);
                    
                    // Add arrival marker
                    const arrivalMarker = L.marker([flight.arrival_lat, flight.arrival_lon], { icon: airportIcon }).addTo(map);
                    arrivalMarker.bindPopup(`<strong>${flight.arrival_airport}</strong><br>Arrival Airport`);
                    
                    // Draw flight path
                    const latlngs = [
                        [flight.departure_lat, flight.departure_lon],
                        [flight.arrival_lat, flight.arrival_lon]
                    ];
                    L.polyline(latlngs, {
                        color: '#1e88e5',
                        weight: 2,
                        opacity: 0.7,
                        className: 'flight-path'
                    }).addTo(map);
                    
                    // Add current position if available
                    if (flight.current_lat && flight.current_lon) {
                        const planeMarker = L.marker([flight.current_lat, flight.current_lon], { icon: planeIcon }).addTo(map);
                        planeMarker.bindPopup(`
                            <strong>${flight.flight_number}</strong><br>
                            Altitude: ${flight.altitude ? flight.altitude.toLocaleString() + ' ft' : 'N/A'}<br>
                            Speed: ${flight.speed ? flight.speed.toLocaleString() + ' km/h' : 'N/A'}
                        `);
                    }
                    
                    // Fit map bounds
                    map.fitBounds(latlngs, { padding: [50, 50], maxZoom: 10 });
                } else if (map && (flight.departure_lat && flight.departure_lon)) {
                    map.setView([flight.departure_lat, flight.departure_lon], 6);
                } else if (map && (flight.arrival_lat && flight.arrival_lon)) {
                    map.setView([flight.arrival_lat, flight.arrival_lon], 6);
                }
            }
            
            // Refresh flight function
            document.getElementById('refreshFlightButton').addEventListener('click', function() {
                const activeFlightCard = document.querySelector('.flight-card.active');
                if (activeFlightCard) {
                    const flightNumber = activeFlightCard.dataset.flightNumber;
                    fetch(`/api/flights/update/${flightNumber}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            displayFlightDetails(data.flight);
                        } else {
                            alert('Error: ' + (data.error || 'Failed to update flight data'));
                        }
                    })
                    .catch(error => {
                        console.error('Error refreshing flight:', error);
                    });
                }
            });
            
            // Refresh all flights function
            document.getElementById('refreshButton').addEventListener('click', function() {
                fetch('/api/flights/update-all')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        fetchFlights();
                        const activeFlightCard = document.querySelector('.flight-card.active');
                        if (activeFlightCard) {
                            const flightNumber = activeFlightCard.dataset.flightNumber;
                            selectFlight(flightNumber);
                        }
                    } else {
                        alert('Error: ' + (data.error || 'Failed to update flights'));
                    }
                })
                .catch(error => {
                    console.error('Error refreshing all flights:', error);
                });
            });
            
            // Auto-refresh toggle
            let autoRefreshInterval = null;
            document.getElementById('autoRefreshToggle').addEventListener('change', function() {
                if (this.checked) {
                    autoRefreshInterval = setInterval(function() {
                        document.getElementById('refreshButton').click();
                    }, 60000); // Refresh every minute
                    document.querySelector('footer small').textContent = `© ${new Date().getFullYear()} Flight Tracker | Data refreshed automatically`;
                } else {
                    clearInterval(autoRefreshInterval);
                    document.querySelector('footer small').textContent = `© ${new Date().getFullYear()} Flight Tracker | Data refreshed manually`;
                }
            });
            
            // Initial fetch of flights
            fetchFlights();
        });
    </script>
</body>
</html>
